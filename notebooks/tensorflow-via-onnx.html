<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Vespa Data Science - TensorFlow: Deploy model to Vespa through ONNX</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
<meta property="og:title" content="Vespa Data Science - TensorFlow: Deploy model to Vespa through ONNX">
<meta property="og:description" content="">
<meta property="og:site-name" content="Vespa Data Science">
<meta name="twitter:title" content="Vespa Data Science - TensorFlow: Deploy model to Vespa through ONNX">
<meta name="twitter:description" content="">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Vespa Data Science</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../notebooks/collect-training-data.html">WIP notebooks</a></li><li class="breadcrumb-item"><a href="../notebooks/tensorflow-via-onnx.html">TensorFlow: Deploy model to Vespa through ONNX</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Vespa for Data Scientists</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Use-case experiments</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false">
 <span class="menu-text">Passage Ranking</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../passage_dataset.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dataset</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../passage_uncertainty_evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">IR evaluation metrics with uncertainty estimates</span></a>
  </div>
</li>
      </ul>
  </li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false">
 <span class="menu-text">Model serving</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth2 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../stateless_sequence_classification_task.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sequence Classification task</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true">
 <span class="menu-text">Use-case modules</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../module_passage.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">passage</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true">
 <span class="menu-text">WIP notebooks</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/collect-training-data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Collect training data from application</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluate application</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/query-model.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Query models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/cord19/cord19_connect_evaluate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to evaluate Vespa ranking functions from python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/cord19/cord19_download_parse_trec_covid.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">How to download and parse TREC-COVID data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/image_search/image-search-scratch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Image search</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../notebooks/tensorflow-via-onnx.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">TensorFlow: Deploy model to Vespa through ONNX</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true">
 <span class="menu-text">Core modules</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../module_stats.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">stats</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../module_evaluation.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">evaluation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../module_query.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">query</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../module_ranking.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ranking</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../module_ml.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ml</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#install-packages" id="toc-install-packages" class="nav-link active" data-scroll-target="#install-packages">Install packages</a></li>
  <li><a href="#get-the-data" id="toc-get-the-data" class="nav-link" data-scroll-target="#get-the-data">Get the data</a></li>
  <li><a href="#create-a-listwise-dataset" id="toc-create-a-listwise-dataset" class="nav-link" data-scroll-target="#create-a-listwise-dataset">Create a listwise dataset</a></li>
  <li><a href="#create-and-compile-model" id="toc-create-and-compile-model" class="nav-link" data-scroll-target="#create-and-compile-model">Create and compile model</a></li>
  <li><a href="#simplify-model-inputoutput-for-deployment" id="toc-simplify-model-inputoutput-for-deployment" class="nav-link" data-scroll-target="#simplify-model-inputoutput-for-deployment">Simplify model input/output for deployment</a></li>
  <li><a href="#define-the-application-package" id="toc-define-the-application-package" class="nav-link" data-scroll-target="#define-the-application-package">Define the application package</a></li>
  <li><a href="#feed-the-application" id="toc-feed-the-application" class="nav-link" data-scroll-target="#feed-the-application">Feed the application</a></li>
  <li><a href="#validate-vespa-predictions" id="toc-validate-vespa-predictions" class="nav-link" data-scroll-target="#validate-vespa-predictions">Validate Vespa predictions</a></li>
  <li><a href="#clean-environment" id="toc-clean-environment" class="nav-link" data-scroll-target="#clean-environment">Clean environment</a></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/vespa-engine/learntorank/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">TensorFlow: Deploy model to Vespa through ONNX</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This tutorial will cover the following steps:</p>
<ol type="1">
<li>Download labeled data containing Vespa ranking features.</li>
<li>Create a listwise dataset based on a TensorFlow data pipeline.</li>
<li>Train a Learning to Rank model (LTR) model using the TensorFlow Ranking framework.</li>
<li>Simplify the LTR model to be suitable for ranking in Vespa</li>
<li>Convert to TensorFlow model to ONNX file format.</li>
<li>Create and deploy a Vespa application that uses the TensorFlow model</li>
<li>Feed data to the Vespa application</li>
<li>Ensure that prediction from the model deployed to Vespa match those obtained from the model directly.</li>
</ol>
<section id="install-packages" class="level2">
<h2 class="anchored" data-anchor-id="install-packages">Install packages</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip3 install <span class="op">-</span>Uqq pyvespa learntorank numpy<span class="op">==</span><span class="fl">1.23.5</span> pandas tensorflow tensorflow_ranking onnx tf2onnx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="get-the-data" class="level2">
<h2 class="anchored" data-anchor-id="get-the-data">Get the data</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Download labeled data containing Vespa ranking features collected from an MS Marco passage ranking application.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"https://data.vespa.oath.cloud/blog/ranking/train_sample.csv"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"document_id"</span>, </span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>     <span class="st">"query_id"</span>, </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>     <span class="st">"label"</span>, </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>     <span class="st">"fieldMatch(body).queryCompleteness"</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>     <span class="st">"fieldMatch(body).significance"</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>     <span class="st">"nativeRank"</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>df.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(100000, 6)</code></pre>
</div>
</div>
<p>For each <code>query_id</code>, there is 9 irrelevant <code>document_id</code> with <code>label = 0</code> and 1 relevant <code>document_id</code> with <code>label = 1</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>df.head(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">document_id</th>
<th data-quarto-table-cell-role="th">query_id</th>
<th data-quarto-table-cell-role="th">label</th>
<th data-quarto-table-cell-role="th">fieldMatch(body).queryCompleteness</th>
<th data-quarto-table-cell-role="th">fieldMatch(body).significance</th>
<th data-quarto-table-cell-role="th">nativeRank</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>27061</td>
<td>3</td>
<td>0</td>
<td>0.625</td>
<td>0.566311</td>
<td>0.042421</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>257</td>
<td>3</td>
<td>0</td>
<td>0.625</td>
<td>0.582570</td>
<td>0.039192</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>363</td>
<td>3</td>
<td>0</td>
<td>0.500</td>
<td>0.466030</td>
<td>0.034418</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>22682</td>
<td>3</td>
<td>0</td>
<td>0.625</td>
<td>0.566311</td>
<td>0.061149</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>160</td>
<td>3</td>
<td>0</td>
<td>0.500</td>
<td>0.437808</td>
<td>0.035017</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>228</td>
<td>3</td>
<td>0</td>
<td>0.500</td>
<td>0.437808</td>
<td>0.032697</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>3901893</td>
<td>3</td>
<td>0</td>
<td>0.750</td>
<td>0.748064</td>
<td>0.074917</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>1142680</td>
<td>3</td>
<td>1</td>
<td>0.750</td>
<td>0.748064</td>
<td>0.099112</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>141</td>
<td>3</td>
<td>0</td>
<td>0.500</td>
<td>0.442879</td>
<td>0.038093</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>3060834</td>
<td>3</td>
<td>0</td>
<td>0.750</td>
<td>0.763933</td>
<td>0.075347</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="create-a-listwise-dataset" class="level2">
<h2 class="anchored" data-anchor-id="create-a-listwise-dataset">Create a listwise dataset</h2>
<p>Define some parameters required to setup the listwise data pipeline.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>number_documents_per_query <span class="op">=</span> <span class="dv">10</span>            </span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>feature_names <span class="op">=</span> [                         </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fieldMatch(body).queryCompleteness"</span>, </span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fieldMatch(body).significance"</span>, </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"nativeRank"</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>number_features <span class="op">=</span> <span class="bu">len</span>(feature_names)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>batch_size<span class="op">=</span><span class="dv">32</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Each feature data point will have the shape equal to <code>(batch_size, number_documents_per_query, number_features)</code> and each label data point will have shape equal to <code>(batch_size, number_documents_per_query)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The code below creates a TensorFlow data pipeline (<code>tf.data.Dataset</code>) from our DataFrame and group the rows by the <code>query_id</code> variable to form a listwise dataset. We then configure the data pipeline to shuffle and set a batch size.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>shuffle_buffer_size <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>ds <span class="op">=</span> tf.data.Dataset.from_tensor_slices(</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"features"</span>: tf.cast(df[feature_names].values, tf.float32),</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">"label"</span>: tf.cast(df[<span class="st">"label"</span>].values, tf.float32),</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"query_id"</span>: tf.cast(df[<span class="st">"query_id"</span>].values, tf.int64),</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>key_func <span class="op">=</span> <span class="kw">lambda</span> x: x[<span class="st">"query_id"</span>]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>reduce_func <span class="op">=</span> <span class="kw">lambda</span> key, dataset: dataset.batch(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    number_documents_per_query, drop_remainder<span class="op">=</span><span class="va">True</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>listwise_ds <span class="op">=</span> ds.group_by_window(</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    key_func<span class="op">=</span>key_func,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    reduce_func<span class="op">=</span>reduce_func,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    window_size<span class="op">=</span>number_documents_per_query,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>listwise_ds <span class="op">=</span> listwise_ds.<span class="bu">map</span>(<span class="kw">lambda</span> x: (x[<span class="st">"features"</span>], x[<span class="st">"label"</span>]))</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>listwise_ds <span class="op">=</span> listwise_ds.shuffle(buffer_size<span class="op">=</span>shuffle_buffer_size).batch(</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    batch_size<span class="op">=</span>batch_size</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see the shape of the <code>features</code> and of the <code>labels</code> are as expected.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> d <span class="kw">in</span> listwise_ds.take(<span class="dv">1</span>):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(d[<span class="dv">0</span>].shape)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(d[<span class="dv">1</span>].shape)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(32, 10, 3)
(32, 10)</code></pre>
</div>
</div>
</section>
<section id="create-and-compile-model" class="level2">
<h2 class="anchored" data-anchor-id="create-and-compile-model">Create and compile model</h2>
<p>We are going to create a linear model that can take a listwise data as input with shape <code>(batch_size, number_documents_per_query, number_features)</code> and output one prediction per document with shape <code>(batch_size, number_documents_per_query)</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>input_layer <span class="op">=</span> tf.keras.layers.Input(shape<span class="op">=</span>(number_documents_per_query, number_features))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>dense_layer <span class="op">=</span> tf.keras.layers.Dense(</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    use_bias<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    activation<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    name<span class="op">=</span><span class="st">"dense"</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>output_layer <span class="op">=</span> tf.keras.layers.Reshape((number_documents_per_query,))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> tf.keras.Sequential(layers<span class="op">=</span>[input_layer, dense_layer, output_layer])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In this tutorial, we want to optimize the <a href="https://en.wikipedia.org/wiki/Discounted_cumulative_gain#Normalized_DCG">Normalized Discounted Cumulative Gain</a> at position 10 (NDCG@10). We then select a loss function that is a smooth approximation of the NDCG metric and create a stateless NDCG@10 metric to use when compiling the model defined above.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow_ranking <span class="im">as</span> tfr</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>ndcg <span class="op">=</span> tfr.keras.metrics.NDCGMetric(topn<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ndcg_stateless(y_true, y_pred):</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">    Create stateless metric so that we can compute the validation metric </span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">    from scratch at the end of each epoch.</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    ndcg.reset_states()</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ndcg(y_true, y_pred)</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> tf.keras.optimizers.Adagrad(learning_rate<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>model.<span class="bu">compile</span>(</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>    optimizer<span class="op">=</span>optimizer,</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    loss<span class="op">=</span>tfr.keras.losses.ApproxNDCGLoss(),</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>ndcg_stateless,</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Use the listwise dataset to fit the model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> model.fit(listwise_ds, epochs<span class="op">=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Epoch 1/20
304/304 [==============================] - 8s 3ms/step - loss: -0.6522 - ndcg_stateless: 0.6874
Epoch 2/20
304/304 [==============================] - 1s 921us/step - loss: -0.6959 - ndcg_stateless: 0.7159
Epoch 3/20
304/304 [==============================] - 1s 905us/step - loss: -0.7001 - ndcg_stateless: 0.7166
Epoch 4/20
304/304 [==============================] - 1s 904us/step - loss: -0.7025 - ndcg_stateless: 0.7168
Epoch 5/20
304/304 [==============================] - 1s 901us/step - loss: -0.7043 - ndcg_stateless: 0.7165
Epoch 6/20
304/304 [==============================] - 1s 920us/step - loss: -0.7106 - ndcg_stateless: 0.7242
Epoch 7/20
304/304 [==============================] - 1s 903us/step - loss: -0.7355 - ndcg_stateless: 0.7647
Epoch 8/20
304/304 [==============================] - 1s 898us/step - loss: -0.7399 - ndcg_stateless: 0.7662
Epoch 9/20
304/304 [==============================] - 1s 923us/step - loss: -0.7430 - ndcg_stateless: 0.7679
Epoch 10/20
304/304 [==============================] - 1s 911us/step - loss: -0.7450 - ndcg_stateless: 0.7679
Epoch 11/20
304/304 [==============================] - 1s 955us/step - loss: -0.7464 - ndcg_stateless: 0.7682
Epoch 12/20
304/304 [==============================] - 1s 914us/step - loss: -0.7475 - ndcg_stateless: 0.7683
Epoch 13/20
304/304 [==============================] - 1s 919us/step - loss: -0.7485 - ndcg_stateless: 0.7689
Epoch 14/20
304/304 [==============================] - 1s 909us/step - loss: -0.7493 - ndcg_stateless: 0.7682
Epoch 15/20
304/304 [==============================] - 1s 904us/step - loss: -0.7499 - ndcg_stateless: 0.7692
Epoch 16/20
304/304 [==============================] - 1s 900us/step - loss: -0.7506 - ndcg_stateless: 0.7691
Epoch 17/20
304/304 [==============================] - 1s 893us/step - loss: -0.7513 - ndcg_stateless: 0.7699
Epoch 18/20
304/304 [==============================] - 1s 1ms/step - loss: -0.7516 - ndcg_stateless: 0.7694
Epoch 19/20
304/304 [==============================] - 1s 910us/step - loss: -0.7520 - ndcg_stateless: 0.7694
Epoch 20/20
304/304 [==============================] - 1s 830us/step - loss: -0.7524 - ndcg_stateless: 0.7686</code></pre>
</div>
</div>
</section>
<section id="simplify-model-inputoutput-for-deployment" class="level2">
<h2 class="anchored" data-anchor-id="simplify-model-inputoutput-for-deployment">Simplify model input/output for deployment</h2>
<p>After training the model by minimizing a listwise loss function, we can simplify the model before deploying it to Vespa. At inference time, Vespa will evaluate each document individually and use a ranking function to rank documents.</p>
<p>Therefore, the input layer will expect a tensor named <code>input</code> with shape equal to <code>(1, number_features)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>simpler_model <span class="op">=</span> tf.keras.Sequential(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    [tf.keras.layers.Input(shape<span class="op">=</span>(number_features,), batch_size<span class="op">=</span><span class="dv">1</span>, name<span class="op">=</span><span class="st">"input"</span>), </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>     dense_layer</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are going to save the <code>simpler_model</code> to disk and then use the tf2onnx tool to convert the model to ONNX format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>simpler_model.save(<span class="st">"simpler_keras_model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>WARNING:tensorflow:Compiled the loaded model, but the compiled metrics have yet to be built. `model.compile_metrics` will be empty until you train or evaluate the model.
INFO:tensorflow:Assets written to: simpler_keras_model/assets</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>INFO:tensorflow:Assets written to: simpler_keras_model/assets</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tf2onnx <span class="im">import</span> convert</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>python3 <span class="op">-</span>m tf2onnx.convert <span class="op">--</span>saved<span class="op">-</span>model simpler_keras_model <span class="op">--</span>output simpler_keras_model.onnx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;frozen runpy&gt;:128: RuntimeWarning: 'tf2onnx.convert' found in sys.modules after import of package 'tf2onnx', but prior to execution of 'tf2onnx.convert'; this may result in unpredictable behaviour
2023-08-08 14:09:40,224 - WARNING - '--tag' not specified for saved_model. Using --tag serve
2023-08-08 14:09:40,328 - INFO - Signatures found in model: [serving_default].
2023-08-08 14:09:40,328 - WARNING - '--signature_def' not specified, using first signature: serving_default
2023-08-08 14:09:40,328 - INFO - Output names: ['dense']
2023-08-08 14:09:40,328 - WARNING - Could not search for non-variable resources. Concrete function internal representation may have changed.
WARNING:tensorflow:From /usr/local/lib/python3.11/site-packages/tf2onnx/tf_loader.py:557: extract_sub_graph (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
This API was designed for TensorFlow v1. See https://www.tensorflow.org/guide/migrate for instructions on how to migrate your code to TensorFlow v2.
2023-08-08 14:09:40,379 - WARNING - From /usr/local/lib/python3.11/site-packages/tf2onnx/tf_loader.py:557: extract_sub_graph (from tensorflow.python.framework.graph_util_impl) is deprecated and will be removed in a future version.
Instructions for updating:
This API was designed for TensorFlow v1. See https://www.tensorflow.org/guide/migrate for instructions on how to migrate your code to TensorFlow v2.
2023-08-08 14:09:40,388 - INFO - Using tensorflow=2.13.0, onnx=1.14.0, tf2onnx=1.8.4/cd55bf
2023-08-08 14:09:40,388 - INFO - Using opset &lt;onnx, 9&gt;
2023-08-08 14:09:40,389 - INFO - Computed 0 values for constant folding
2023-08-08 14:09:40,395 - INFO - Optimizing ONNX model
2023-08-08 14:09:40,402 - INFO - After optimization: Identity -5 (5-&gt;0)
2023-08-08 14:09:40,403 - INFO - 
2023-08-08 14:09:40,403 - INFO - Successfully converted TensorFlow model simpler_keras_model to ONNX
2023-08-08 14:09:40,403 - INFO - Model inputs: ['input:0']
2023-08-08 14:09:40,403 - INFO - Model outputs: ['dense']
2023-08-08 14:09:40,403 - INFO - ONNX model is saved at simpler_keras_model.onnx</code></pre>
</div>
</div>
<p>We can inspect the onnx model input and output. We first load the ONNX model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> onnx                  </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>m <span class="op">=</span> onnx.load(<span class="st">"simpler_keras_model.onnx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As mentioned before, the model expects a tensor named <code>input</code> with shape <code>(1, 3)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>m.graph.<span class="bu">input</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[name: "input"
type {
  tensor_type {
    elem_type: 1
    shape {
      dim {
        dim_value: 1
      }
      dim {
        dim_value: 3
      }
    }
  }
}
]</code></pre>
</div>
</div>
<p>The output will be a tensor named <code>dense</code> with shape <code>(1,1)</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>m.graph.output</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>[name: "dense"
type {
  tensor_type {
    elem_type: 1
    shape {
      dim {
        dim_value: 1
      }
      dim {
        dim_value: 1
      }
    }
  }
}
]</code></pre>
</div>
</div>
</section>
<section id="define-the-application-package" class="level2">
<h2 class="anchored" data-anchor-id="define-the-application-package">Define the application package</h2>
<p>This section will use the Vespa python API <code>pyvespa</code> to create an application package with a ranking function that uses the tensorflow model exported to ONNX.</p>
<p>The data used to train the model was derived from a Vespa application based on the MS Marco passage dataset. So, we are going to name the application <code>msmarco</code>, and start by adding two fields: <code>id</code> to hold the document id and <code>text</code> to hold the passages from the msmarco dataset.</p>
<p><code>indexing</code> configuration: We add <code>"summary"</code> to the <code>indexing</code> parameter because we want to include both the <code>id</code> and the <code>text</code> field in the query results. The <code>"attribute"</code> indicates that the field <code>id</code> will be stored in-memory. The <code>"index"</code> indicates that Vespa will create a search index for the <code>text</code> field.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vespa.package <span class="im">import</span> ApplicationPackage, Field</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>app_package <span class="op">=</span> ApplicationPackage(name<span class="op">=</span><span class="st">"msmarco"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>app_package.schema.add_fields(</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    Field(name<span class="op">=</span><span class="st">"id"</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>, indexing<span class="op">=</span>[<span class="st">"summary"</span>, <span class="st">"attribute"</span>]),</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    Field(name<span class="op">=</span><span class="st">"text"</span>, <span class="bu">type</span><span class="op">=</span><span class="st">"string"</span>, indexing<span class="op">=</span>[<span class="st">"summary"</span>, <span class="st">"index"</span>])</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that at each step along the application package definition, we can inspect the content of the Vespa search definition file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(app_package.schema.schema_to_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>schema msmarco {
    document msmarco {
        field id type string {
            indexing: summary | attribute
        }
        field text type string {
            indexing: summary | index
        }
    }
}</code></pre>
</div>
</div>
<p>Add <code>simpler_keras_model.onnx</code> to the schema. * The <code>model_name</code> is an id that can be used in the ranking function to identify which model to use. * The <code>model_file_path</code> is the current path of the .onnx file. When deploying the application, <code>pyvespa</code> will move the file to the correct location inside the Vespa application package folder. * The <code>inputs</code> maps the name of the inputs contained in the ONNX model to the name of the Vespa source that will be used as input to the model. In this case we will create a function called <code>vespa_input</code> that output a tensor of type float with the expected shape <code>(1, 3)</code>. * The <code>outputs</code> maps the output name in the ONNX file to the output name that will be recognized by Vespa.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vespa.package <span class="im">import</span> OnnxModel</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>app_package.schema.add_model(</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    OnnxModel(</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>        model_name<span class="op">=</span><span class="st">"ltr_tensorflow"</span>,</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        model_file_path<span class="op">=</span><span class="st">"simpler_keras_model.onnx"</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        inputs<span class="op">=</span>{<span class="st">"input"</span>: <span class="st">"vespa_input"</span>},</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>        outputs<span class="op">=</span>{<span class="st">"dense"</span>: <span class="st">"dense"</span>},</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It is possible to see the addition of the <code>onnx-model</code> section in the search definition below. Note that the model file is expected to be under the <code>files</code> folder inside the final application package folder, but <code>pyvespa</code> takes care of the model file placement when deploying the application.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(app_package.schema.schema_to_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>schema msmarco {
    document msmarco {
        field id type string {
            indexing: summary | attribute
        }
        field text type string {
            indexing: summary | index
        }
    }
    onnx-model ltr_tensorflow {
        file: files/ltr_tensorflow.onnx
        input input:0: vespa_input
        output dense: dense
    }
}</code></pre>
</div>
</div>
<p>Add a rank profile named <code>tensorflow</code> that uses the TensorFlow model to rank documents. * <code>first_phase</code>: We use the Vespa ranking feature <code>onnx</code> to access the ONNX model named <code>ltr_tensorflow</code> and use the output <code>dense</code>. We apply the <code>sum</code> because Vespa requires the relevance score to be a scaler and the output of the ONNX model in this case is a tensor of shape <code>(1,1)</code>. * <code>vespa_input</code> function: The ONNX model was trained with the features <code>fieldMatch(text).queryCompleteness</code>, <code>fieldMatch(text).significance</code> and <code>nativeRank(text)</code> and expects and tensor of shape <code>(1,3)</code> containing those features. * <code>summary_features</code>: Summary features allow us to specify Vespa features to be included in the output of a query. In this case, we want to access to the model inputs and output to check if the Vespa model evaluation is the same as if we use the original TensorFlow model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vespa.package <span class="im">import</span> RankProfile, Function</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>app_package.schema.add_rank_profile(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    RankProfile(</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        name<span class="op">=</span><span class="st">"tensorflow"</span>, </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        first_phase<span class="op">=</span><span class="st">"sum(onnx(ltr_tensorflow).dense)"</span>, </span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>        functions<span class="op">=</span>[</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>            Function(</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>                name<span class="op">=</span><span class="st">"vespa_input"</span>, </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>                expression<span class="op">=</span><span class="st">"tensor&lt;float&gt;(x[1],y[3]):[["</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fieldMatch(text).queryCompleteness, "</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fieldMatch(text).significance, "</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"nativeRank(text)"</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">"]]"</span></span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>        summary_features<span class="op">=</span>[</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>            <span class="st">"onnx(ltr_tensorflow)"</span>, </span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fieldMatch(text).queryCompleteness"</span>, </span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fieldMatch(text).significance"</span>, </span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nativeRank(text)"</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>rank-profile</code> called tensorflow can be seen below:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(app_package.schema.schema_to_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>schema msmarco {
    document msmarco {
        field id type string {
            indexing: summary | attribute
        }
        field text type string {
            indexing: summary | index
        }
    }
    onnx-model ltr_tensorflow {
        file: files/ltr_tensorflow.onnx
        input input:0: vespa_input
        output dense: dense
    }
    rank-profile tensorflow {
        function vespa_input() {
            expression {
                tensor&lt;float&gt;(x[1],y[3]):[[fieldMatch(text).queryCompleteness, fieldMatch(text).significance, nativeRank(text)]]
            }
        }
        first-phase {
            expression {
                sum(onnx(ltr_tensorflow).dense)
            }
        }
        summary-features {
            onnx(ltr_tensorflow)
            fieldMatch(text).queryCompleteness
            fieldMatch(text).significance
            nativeRank(text)
        }
    }
}</code></pre>
</div>
</div>
<p>Now that we are done with the application package definition. We can deploy the application:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> vespa.deployment <span class="im">import</span> VespaDocker</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>vespa_docker <span class="op">=</span> VespaDocker()</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> vespa_docker.deploy(application_package<span class="op">=</span>app_package)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Waiting for configuration server, 0/300 seconds...
Waiting for configuration server, 5/300 seconds...
Waiting for application status, 0/300 seconds...
Waiting for application status, 5/300 seconds...
Waiting for application status, 10/300 seconds...
Waiting for application status, 15/300 seconds...
Waiting for application status, 20/300 seconds...
Waiting for application status, 25/300 seconds...
Finished deployment.</code></pre>
</div>
</div>
</section>
<section id="feed-the-application" class="level2">
<h2 class="anchored" data-anchor-id="feed-the-application">Feed the application</h2>
<p>Once the application is running, it is time to feed msmarco passage data to it.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> learntorank.passage <span class="im">import</span> PassageData</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>dataset <span class="op">=</span> PassageData.load()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are going to use only 10 documents because our goal here is to show that Vespa returns the correct predictions from the TensorFlow model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> dataset.get_corpus().head(<span class="dv">10</span>)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>data.rename(columns<span class="op">=</span>{<span class="st">'doc_id'</span>: <span class="st">'id'</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th">text</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>5954248</td>
<td>Why GameStop is excited for Dragon Age: Inquis...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>7290700</td>
<td>metaplasia definition: 1. abnormal change of o...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>5465518</td>
<td>Candice Net Worth. According to the report of ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3100518</td>
<td>Under the Base Closure Act, March AFB was down...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>3207764</td>
<td>There are a number of career opportunities for...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Feed the <code>data</code> to the application.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>result <span class="op">=</span> app.feed_df(df<span class="op">=</span>data, include_id<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Successful documents fed: 10/10.
Batch progress: 1/1.</code></pre>
</div>
</div>
</section>
<section id="validate-vespa-predictions" class="level2">
<h2 class="anchored" data-anchor-id="validate-vespa-predictions">Validate Vespa predictions</h2>
<p>Get query from the small dev set to use to validate Vespa TensorFlow predictions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>query_text <span class="op">=</span> dataset.get_queries(<span class="bu">type</span><span class="op">=</span><span class="st">"dev"</span>).iloc[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>query_text <span class="op">=</span> query_text.replace(<span class="st">"'"</span>, <span class="st">""</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>query_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'why say the sky is the limit'</code></pre>
</div>
</div>
<p>The code below shows the YQL expression that will be used to select the documents to be ranked.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">"select * from sources * where ({{grammar: 'any', defaultIndex: 'text'}}userInput('{}'))"</span>.<span class="bu">format</span>(query_text)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"select * from sources * where ({grammar: 'any', defaultIndex: 'text'}userInput('why say the sky is the limit'))"</code></pre>
</div>
</div>
<p>The function <code>get_vespa_prediction_and_features</code> will match documents using the YQL expression above and rank the documents with the rank-profile <code>tensorflow</code> that we defined in the Vespa application package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_vespa_prediction_and_features(query_text):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Send query and extract hits</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    hits <span class="op">=</span> app.query(</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>                body<span class="op">=</span>{</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"yql"</span>: <span class="st">"select * from sources * where (</span><span class="sc">{{</span><span class="st">'grammar': 'any', 'defaultIndex': 'text'</span><span class="sc">}}</span><span class="st">userInput('</span><span class="sc">{}</span><span class="st">'));"</span>.<span class="bu">format</span>(query_text),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"ranking"</span>: <span class="st">"tensorflow"</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>            ).hits</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span>[]</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For each hit, extract the inputs to the model along with model predictions computed by Vespa</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> hit <span class="kw">in</span> hits:</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>        result.append({</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fieldMatch(text).queryCompleteness"</span>: hit[<span class="st">"fields"</span>][<span class="st">"summaryfeatures"</span>][<span class="st">"fieldMatch(text).queryCompleteness"</span>],</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>            <span class="st">"fieldMatch(text).significance"</span>: hit[<span class="st">"fields"</span>][<span class="st">"summaryfeatures"</span>][<span class="st">"fieldMatch(text).significance"</span>],</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>            <span class="st">"nativeRank(text)"</span>: hit[<span class="st">"fields"</span>][<span class="st">"summaryfeatures"</span>][<span class="st">"nativeRank(text)"</span>],</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>            <span class="st">"vespa_prediction"</span>: hit[<span class="st">"relevance"</span>],             </span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame.from_records(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Inputs and vespa predictions:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> get_vespa_prediction_and_features(query_text<span class="op">=</span>query_text)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>predictions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fieldMatch(text).queryCompleteness</th>
<th data-quarto-table-cell-role="th">fieldMatch(text).significance</th>
<th data-quarto-table-cell-role="th">nativeRank(text)</th>
<th data-quarto-table-cell-role="th">vespa_prediction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.285714</td>
<td>0.199799</td>
<td>0.061853</td>
<td>0.360788</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.571429</td>
<td>0.415687</td>
<td>0.086940</td>
<td>-0.128510</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.065154</td>
<td>-0.240481</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.050600</td>
<td>-0.670632</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.049802</td>
<td>-0.694231</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.285714</td>
<td>0.199799</td>
<td>0.025552</td>
<td>-0.712175</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.045398</td>
<td>-0.824390</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Compute predictions from the TensorFlow model <code>simpler_model</code> directly:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>predictions[<span class="st">"tf_prediction"</span>] <span class="op">=</span> predictions[</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    [<span class="st">"fieldMatch(text).queryCompleteness"</span>, <span class="st">"fieldMatch(text).significance"</span>, <span class="st">"nativeRank(text)"</span>]</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: simpler_model.predict([x.tolist()])[<span class="dv">0</span>][<span class="dv">0</span>], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>1/1 [==============================] - 0s 71ms/step
1/1 [==============================] - 0s 28ms/step
1/1 [==============================] - 0s 29ms/step
1/1 [==============================] - 0s 29ms/step
1/1 [==============================] - 0s 28ms/step
1/1 [==============================] - 0s 26ms/step
1/1 [==============================] - 0s 26ms/step</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>predictions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fieldMatch(text).queryCompleteness</th>
<th data-quarto-table-cell-role="th">fieldMatch(text).significance</th>
<th data-quarto-table-cell-role="th">nativeRank(text)</th>
<th data-quarto-table-cell-role="th">vespa_prediction</th>
<th data-quarto-table-cell-role="th">tf_prediction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.285714</td>
<td>0.199799</td>
<td>0.061853</td>
<td>0.360788</td>
<td>0.360788</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.571429</td>
<td>0.415687</td>
<td>0.086940</td>
<td>-0.128510</td>
<td>-0.128510</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.065154</td>
<td>-0.240481</td>
<td>-0.240481</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.050600</td>
<td>-0.670632</td>
<td>-0.670632</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.049802</td>
<td>-0.694231</td>
<td>-0.694231</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>0.285714</td>
<td>0.199799</td>
<td>0.025552</td>
<td>-0.712175</td>
<td>-0.712176</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>0.428571</td>
<td>0.302071</td>
<td>0.045398</td>
<td>-0.824390</td>
<td>-0.824390</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Check that the predictions from the model deployed in Vespa are (almost) equal to the predictions obtained directly from the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy.testing <span class="im">import</span> assert_almost_equal</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>assert_almost_equal(predictions[<span class="st">"vespa_prediction"</span>].tolist(), predictions[<span class="st">"tf_prediction"</span>].tolist(), <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="clean-environment" class="level2">
<h2 class="anchored" data-anchor-id="clean-environment">Clean environment</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shutil</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>shutil.rmtree(<span class="st">"simpler_keras_model"</span>) </span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>vespa_docker.container.stop(timeout<span class="op">=</span><span class="dv">600</span>)</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>vespa_docker.container.remove()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>